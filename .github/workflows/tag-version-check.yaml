name: Tag Version Validation

on:
  push:
    tags:
      - 'v*'

jobs:
  validate:
    name: Ensure tag matches package version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check tag against package.json
        id: check
        run: |
          TAG_NAME="${GITHUB_REF##*/}"
          TAG_VERSION="${TAG_NAME#v}"
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "tag_version=${TAG_VERSION}" >> "$GITHUB_OUTPUT"
          echo "package_version=${PACKAGE_VERSION}" >> "$GITHUB_OUTPUT"

          if [[ "${TAG_VERSION}" == *-next ]]; then
            echo "is_prerelease_tag=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease_tag=false" >> "$GITHUB_OUTPUT"
          fi

          if [[ "${TAG_VERSION}" == *-next || "${PACKAGE_VERSION}" == *-next ]]; then
            echo "allow_publish=false" >> "$GITHUB_OUTPUT"
          else
            echo "allow_publish=true" >> "$GITHUB_OUTPUT"
          fi

          if [ "${TAG_VERSION}" != "${PACKAGE_VERSION}" ]; then
            echo "mismatch=true" >> "$GITHUB_OUTPUT"
          else
            echo "mismatch=false" >> "$GITHUB_OUTPUT"
          fi

          node <<'NODE'
          const fs = require('fs');
          const tag = process.env.TAG_VERSION.replace(/^v/, '');
          function nextPatch(version) {
            const [major, minor, patchPart] = version.split('.');
            const numericPatch = parseInt(patchPart.split('-')[0], 10);
            return `${major}.${minor}.${numericPatch + 1}`;
          }
          const corrected = nextPatch(tag);
          fs.writeFileSync('/tmp/correction-version', corrected);
          NODE

          CORRECTION_VERSION=$(cat /tmp/correction-version)
          echo "correction_version=${CORRECTION_VERSION}" >> "$GITHUB_OUTPUT"
          NEXT_DEV_VERSION="${CORRECTION_VERSION}-next"
          echo "next_dev_version=${NEXT_DEV_VERSION}" >> "$GITHUB_OUTPUT"
        env:
          TAG_VERSION: ${{ github.ref_name }}

      - name: Prepare correction pull request when mismatched
        if: steps.check.outputs.mismatch == 'true'
        run: |
          TARGET_VERSION=${{ steps.check.outputs.correction_version }}
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const version = process.env.TARGET_VERSION;
          const pkgPath = path.join(process.cwd(), 'package.json');
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
          pkg.version = version;
          fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');

          const lockPath = path.join(process.cwd(), 'package-lock.json');
          if (fs.existsSync(lockPath)) {
            const lock = JSON.parse(fs.readFileSync(lockPath, 'utf8'));
            lock.version = version;
            if (lock.packages && lock.packages['']) {
              lock.packages[''].version = version;
            }
            fs.writeFileSync(lockPath, JSON.stringify(lock, null, 2) + '\n');
          }
          NODE
        env:
          TARGET_VERSION: ${{ steps.check.outputs.correction_version }}

      - name: Open correction pull request
        if: steps.check.outputs.mismatch == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: correct package version to ${{ steps.check.outputs.correction_version }}"
          title: "chore: correct package version to ${{ steps.check.outputs.correction_version }}"
          body: |
            The tag `${{ steps.check.outputs.tag_version }}` does not match the package version `${{ steps.check.outputs.package_version }}`.

            This PR removes the `-next` suffix and bumps to `${{ steps.check.outputs.correction_version }}` to realign future releases with the published tag.
          branch: "chore/fix-version-${{ steps.check.outputs.correction_version }}"
          delete-branch: true
          add-paths: |
            package.json
            package-lock.json

      - name: Fail when tag and package versions differ
        if: steps.check.outputs.mismatch == 'true'
        run: |
          echo "Tag version does not match package version. A correction PR has been opened." >&2
          exit 1

      - name: Ensure GitHub release exists
        if: steps.check.outputs.mismatch == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            const { owner, repo } = context.repo;

            const releases = await github.paginate(github.rest.repos.listReleases, { owner, repo });
            const existing = releases.find((release) => release.tag_name === tagName);

            if (existing) {
              core.info(`Release for ${tagName} already exists.`);
              return;
            }

            await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name: tagName,
              name: tagName,
              generate_release_notes: true,
              draft: false,
              prerelease: ${{ steps.check.outputs.is_prerelease_tag }},
            });
            core.info(`Created release for ${tagName}.`);

      - name: Setup Node.js for publishing
        if: steps.check.outputs.mismatch == 'false' && steps.check.outputs.allow_publish == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish package to npm
        if: steps.check.outputs.mismatch == 'false' && steps.check.outputs.allow_publish == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm ci
          npm run build
          npm publish --access=public

      - name: Prepare next -next development version
        if: steps.check.outputs.mismatch == 'false' && !contains(steps.check.outputs.tag_version, '-next')
        run: |
          NEXT_DEV_VERSION=${{ steps.check.outputs.next_dev_version }}
          export NEXT_DEV_VERSION
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const nextVersion = process.env.NEXT_DEV_VERSION;
          const pkgPath = path.join(process.cwd(), 'package.json');
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
          pkg.version = nextVersion;
          fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');

          const lockPath = path.join(process.cwd(), 'package-lock.json');
          if (fs.existsSync(lockPath)) {
            const lock = JSON.parse(fs.readFileSync(lockPath, 'utf8'));
            lock.version = nextVersion;
            if (lock.packages && lock.packages['']) {
              lock.packages[''].version = nextVersion;
            }
            fs.writeFileSync(lockPath, JSON.stringify(lock, null, 2) + '\n');
          }
          NODE

      - name: Create next iteration pull request
        if: steps.check.outputs.mismatch == 'false' && !contains(steps.check.outputs.tag_version, '-next')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: prepare ${{ steps.check.outputs.next_dev_version }}"
          title: "chore: prepare ${{ steps.check.outputs.next_dev_version }}"
          body: |
            This pull request prepares the repository for the next development cycle following `${{ steps.check.outputs.tag_version }}`.

            * Publishes `${{ steps.check.outputs.tag_version }}` to npm
            * Bumps the package version to `${{ steps.check.outputs.next_dev_version }}` to continue `-next` development.
          branch: "chore/prepare-${{ steps.check.outputs.next_dev_version }}"
          delete-branch: true
          add-paths: |
            package.json
            package-lock.json
